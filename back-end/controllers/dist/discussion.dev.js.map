{"version":3,"sources":["discussion.js"],"names":["fs","require","queryDbb","exports","createDiscussion","req","res","next","userId","user","title","body","insert","discussionCreate","result","status","json","error","getAllDiscussion","discussionSelectAll","getOneDiscussion","id","params","discussionSelectOne","deleteDiscussion","isAdmin","userIsAdmin","insertId","selectMessageForDiscussionDelete","messageIds","i","length","fileFind","queryStringFindFile","file","filename","split","unlinkSync","commentDeleteMessageId","discussionDeleteLikeMessage","discussionDeleteMessage","discussionDelete","createMessage","message","text_message","discussionId","date","Date","protocol","get","messageCreate","getAllMessage","messageSelectAll","insert2","messageNbLike","nb_like","nbLike","deleteMessage","messageId","insertMessageId","messageUserIdBeforeDelete","user_id","messageDeleteLike","queryStringFile","messageDelete","likeMessage","message_id","insertFirst","insertForDelete","messageUserLike","resultUser","messageUserDislike","messageLike","commentMessage","comment","text_comment","messageCommentCreate","getComment","commentSelectAll","deleteComment","commentId","insertCommentId","commentSelectUserIdBeforeDelete","commentDeleteCommentId"],"mappings":"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","sourcesContent":["const fs = require('fs');\nconst queryDbb = require('../queryBdd');\n\n//Création d'une discussion\nexports.createDiscussion = async (req, res, next) => {\n  const userId = req.user;\n  const title = req.body.title;\n  const insert = [userId, title];\n\n  const result = await queryDbb.discussionCreate(insert);\n  try {\n    return res.status(200).json(result);\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n};\n\n//récupération de toutes les discussion\nexports.getAllDiscussion = async (req, res, next) => {\n\n  const result = await queryDbb.discussionSelectAll();\n  try {\n    return res.status(200).json(result);\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n};\n\n//récupération d'une discussion par son id\nexports.getOneDiscussion = async (req, res, next) => {\n  const id = req.params.id;\n  const insert = [id];\n\n  const result = await queryDbb.discussionSelectOne(insert);\n  try {\n    return res.status(200).json(result);\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n};\n\n//suppression d'une discussion \nexports.deleteDiscussion = async (req, res, next) => {\n  const id = req.params.id;\n  const isAdmin = req.userIsAdmin;\n  const insertId = [id]\n\n  if (isAdmin == 1) {\n    //je récupère tous les id des messages de la discussion\n    const messageIds = await queryDbb.selectMessageForDiscussionDelete(insertId);\n\n    for (let i = 0; i < messageIds.length; i++) {\n      const insert = [messageIds[i].id];\n\n      let queryStringFindFile = await queryDbb.fileFind(insert);\n\n      if (queryStringFindFile[0].file !== null) {\n        const filename = queryStringFindFile[0].file.split('/images/')[1];\n        fs.unlinkSync(`./images/${filename}`);\n      }\n\n      try {\n        await queryDbb.commentDeleteMessageId(insert);\n        await queryDbb.discussionDeleteLikeMessage(insert);\n        await queryDbb.discussionDeleteMessage(insertId);\n        await queryDbb.discussionDelete(insertId);\n      } catch ( err ) {\n        return res.status(500).json({ error: \"mysql\" });\n      }\n    }\n\n    return res.status(200).json(\"Discussion supprimée\");\n\n  } else {\n    //Si l'utilisateur n'est pas admin\n    return res.status(400).json({error: \"Vous n'êtes pas autorisé à supprimer cette discussion\"});\n  }\n};\n\n//création d'un message\nexports.createMessage = async (req, res, next) => {\n  const userId = req.user;\n  const message = req.body.text_message;\n  const discussionId = req.body.discussionId;\n  const date = new Date();\n  \n  let file = null\n\n  if (req.file) {\n      file = `${req.protocol}://${req.get('host')}/images/${req.file.filename}`\n  }\n\n  const insert = [userId, discussionId, message, date, file];\n\n  const result = await queryDbb.messageCreate(insert);\n  try {\n    return res.status(200).json(result);\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n};\n\n//récupération de tous les messages\nexports.getAllMessage = async (req, res, next) => {\n  const discussionId = req.params.id;\n  const insert = [discussionId];\n\n  const result = await queryDbb.messageSelectAll(insert);\n  \n    for (let i=0; i < result.length; i++) {\n      let insert2 = [result[i].id];\n      const nb_like = await queryDbb.messageNbLike(insert2);\n\n      try {\n        result[i].nbLike = nb_like[0].nb_like;\n      } catch (err) {\n        return res.status(500).json({ error: error });\n      }\n    } \n    return res.status(200).json(result);\n    \n  \n};\n\n//suppression d'un message \nexports.deleteMessage = async (req, res, next) => {\n  const userId = req.user;\n  const messageId = req.body.id;\n  const isAdmin = req.userIsAdmin;\n  const insertMessageId = [messageId];\n\n  //1 On vérifie que l'utilisateur correspond à l'utilisateur qui a posté le message ou qu'il est admin\n  const result = await queryDbb.messageUserIdBeforeDelete(insertMessageId);\n  \n  \n  try {\n    //Si l'utilisateur n'est pas celui qui a posté le message, on renvoie une erreur pour lui dire qu'il ne peut pas supprimer le message\n    if (result[0].user_id != userId && isAdmin == 0) {\n      return res.status(400).json({message: \"Vous ne pouvez pas supprimer ce message !\"});\n    }\n\n    await queryDbb.commentDeleteMessageId(insertMessageId);\n    await queryDbb.messageDeleteLike(insertMessageId);\n\n    const queryStringFile = await queryDbb.fileFind(insertMessageId);\n    if (queryStringFile[0].file !== null) {\n      const filename = queryStringFile[0].file.split('/images/')[1];\n      fs.unlinkSync(`./images/${filename}`);              \n    }\n    \n    await queryDbb.messageDelete(insertMessageId);\n\n    return res.status(200).json({\"message\": \"Message supprimé\"});\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n    \n};\n\n//Insertion d'un like\nexports.likeMessage = async (req, res, next) => {\n  const userId = req.user\n  const messageId = req.body.message_id;\n  const date = new Date();\n  const insertFirst = [userId, messageId, date];\n  const insertMessageId = [messageId];\n  const insertForDelete = [userId, messageId];\n\n  const resultUser = await queryDbb.messageUserLike(insertMessageId);\n  //on va vérifier si l'utilisateur a déjà aimé le message\n  try {\n      //Si l'utilisateur a déjà aimé le like, on le supprime de la base\n      if (resultUser.length > 0 && resultUser[0].user_id == userId) {\n        await queryDbb.messageUserDislike(insertForDelete);\n        return res.status(200).json({message: \"Like supprimé de la base\"});\n      } else {\n        //si non on l'ajoute à la base\n        const result = await queryDbb.messageLike(insertFirst);\n        return res.status(200).json(result);\n      }\n  } catch ( err ) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n}\n\n\n//création d'un commentaire\nexports.commentMessage = async (req, res, next) => {\n  const userId = req.user\n  const messageId = req.body.message_id;\n  const comment = req.body.text_comment;\n  const date = new Date();\n  const insert = [userId, messageId, comment, date]\n\n  const result = await queryDbb.messageCommentCreate(insert);\n  try {\n    return res.status(200).json(result);\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n};\n\n//récupérations des commentaires\nexports.getComment = async (req, res, next) => {\n  const userId = req.user\n  const messageId = req.params.id;\n  const insert = [messageId];\n\n  const result = await queryDbb.commentSelectAll(insert);\n  try {\n    return res.status(200).json(result);\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n};\n\n//suppression d'un commentaire \nexports.deleteComment = async (req, res, next) => {\n  const userId = req.user\n  const commentId = req.body.id;\n  const isAdmin = req.userIsAdmin;\n  const insertCommentId = [commentId];\n  \n  const result = await queryDbb.commentSelectUserIdBeforeDelete(insertCommentId);\n  // On vérifie que l'utilisateur est celui qui a posté le commentaire ou qu'il est admin\n  if (result[0].user_id != userId && isAdmin == 0) {\n    return res.status(400).json({message: \"Vous ne pouvez pas supprimer ce commentaire !\"});\n  }\n  try {\n    await queryDbb.commentDeleteCommentId(insertCommentId);\n    return res.status(200).json({message: \"Commentaire supprimé\"});\n  } catch (err) {\n    return res.status(500).json({ error: \"mysql\" });\n  }\n};"],"file":"discussion.dev.js"}