"use strict";var fs=require("fs"),bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),queryDbb=require("../queryBdd"),emailRegex=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,passwordRegex=/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{4,8}$/;exports.signup=function(r,s){var a,u,o,c,i,t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=r.body.name,u=r.body.firstName,o=r.body.email,c=r.body.password,i=null,r.file&&(i="".concat(r.protocol,"://").concat(r.get("host"),"/images/").concat(r.file.filename)),emailRegex.test(o)){e.next=8;break}return e.abrupt("return",s.status(400).json({error:"l'email n'est pas valide"}));case 8:if(passwordRegex.test(c)){e.next=10;break}return e.abrupt("return",s.status(400).json({error:"mot de passe non valide : il doit contenir entre 4 et 8 caractères, 1 majuscule, 1 minuscule et 1 chiffre"}));case 10:if(null==a||null==u||null==o||null==c)return e.abrupt("return",s.status(400).json({error:"items manquants"}));e.next=12;break;case 12:return t=[o],e.next=15,regeneratorRuntime.awrap(queryDbb.userEmailUnique(t));case 15:if(n=e.sent,e.prev=16,!(0<n.length)){e.next=22;break}if(n[0].email==o)return e.abrupt("return",s.status(400).json({error:"l'email est déjà utilisé !"}));e.next=20;break;case 20:e.next=23;break;case 22:bcrypt.hash(c,10).then(function(r){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=[a,u,o,c=r,i],e.next=4,regeneratorRuntime.awrap(queryDbb.userCreate(t));case 4:return n=e.sent,e.abrupt("return",s.status(200).json(n));case 6:case"end":return e.stop()}})}).catch(function(e){return s.status(500).json({error:e})});case 23:e.next=28;break;case 25:return e.prev=25,e.t0=e.catch(16),e.abrupt("return",s.status(500).json({error:"mysql2"}));case 28:case"end":return e.stop()}},null,null,[[16,25]])},exports.login=function(r,t){var n,s,a,u,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body.email,s=r.body.password,a=[n],e.next=5,regeneratorRuntime.awrap(queryDbb.userLogin(a));case 5:if(u=e.sent,e.prev=6,!u[0]){e.next=12;break}o=u[0].password.toString("utf-8"),bcrypt.compare(s,o).then(function(e){return 0==e?t.status(401).json({error:"Mot de passe incorrect !"}):t.status(200).json({userId:u[0].id,token:jwt.sign({userId:u[0].id,isAdmin:u[0].isAdmin},"RANDOM_TOKEN_SECRET",{expiresIn:"24h"})})}).catch(function(e){console.log(e)}),e.next=13;break;case 12:return e.abrupt("return",t.status(401).json({error:"Utilisateur non trouvé !"}));case 13:e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(6),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 18:case"end":return e.stop()}},null,null,[[6,15]])},exports.getProfil=function(r,t){var n,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=[n],e.next=4,regeneratorRuntime.awrap(queryDbb.userProfil(s));case 4:if(a=e.sent,e.prev=5,a[0]){e.next=10;break}return e.abrupt("return",t.status(400).json({error:"l'id ne correspond pas"}));case 10:return e.abrupt("return",t.status(200).json(a[0]));case 11:e.next=16;break;case 13:return e.prev=13,e.t0=e.catch(5),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 16:case"end":return e.stop()}},null,null,[[5,13]])},exports.updateProfil=function(r,t){var n,s,a,u,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s="".concat(r.protocol,"://").concat(r.get("host"),"/images/").concat(r.file.filename),a=[s,n],u=[n],e.next=6,regeneratorRuntime.awrap(queryDbb.userProfilPhoto(u));case 6:return null!==(o=e.sent)[0].photo&&(c=o[0].photo.split("/images/")[1],fs.unlinkSync("./images/".concat(c))),e.next=10,regeneratorRuntime.awrap(queryDbb.userProfilUpdate(a));case 10:return e.prev=10,e.abrupt("return",t.status(200).json({message:"photo mise à jour"}));case 14:return e.prev=14,e.t0=e.catch(10),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 17:case"end":return e.stop()}},null,null,[[10,14]])},exports.deleteProfil=function(r,t){var n,s,a,u,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=[n],e.next=4,regeneratorRuntime.awrap(queryDbb.userProfilPhoto(s));case 4:return null!==(a=e.sent)[0].photo&&(u=a[0].photo.split("/images/")[1],fs.unlinkSync("./images/".concat(u))),e.next=8,regeneratorRuntime.awrap(queryDbb.fileMessageDeleteUser(s));case 8:return o=e.sent,console.log(o),console.log(o.length),0<o.length&&(c=o[0].file.split("/images/")[1],fs.unlinkSync("./images/".concat(c))),e.prev=12,e.next=15,regeneratorRuntime.awrap(queryDbb.userDelete(s));case 15:return e.abrupt("return",t.status(200).json("Profil supprimé"));case 18:return e.prev=18,e.t0=e.catch(12),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 21:case"end":return e.stop()}},null,null,[[12,18]])};
//# sourceMappingURL=user.min.js.map
