"use strict";var fs=require("fs"),queryDbb=require("../queryBdd");exports.createDiscussion=function(r,t){var n,s,a,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=r.body.title,a=[n,s],e.next=5,regeneratorRuntime.awrap(queryDbb.discussionCreate(a));case 5:return u=e.sent,e.prev=6,e.abrupt("return",t.status(200).json(u));case 10:return e.prev=10,e.t0=e.catch(6),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 13:case"end":return e.stop()}},null,null,[[6,10]])},exports.getAllDiscussion=function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(queryDbb.discussionSelectAll());case 2:return t=e.sent,e.prev=3,e.abrupt("return",r.status(200).json(t));case 7:return e.prev=7,e.t0=e.catch(3),e.abrupt("return",r.status(500).json({error:"mysql2"}));case 10:case"end":return e.stop()}},null,null,[[3,7]])},exports.getOneDiscussion=function(r,t){var n,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params.id,s=[n],e.next=4,regeneratorRuntime.awrap(queryDbb.discussionSelectOne(s));case 4:return a=e.sent,e.prev=5,e.abrupt("return",t.status(200).json(a));case 9:return e.prev=9,e.t0=e.catch(5),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 12:case"end":return e.stop()}},null,null,[[5,9]])},exports.deleteDiscussion=function(r,t){var n,s,a,u,c,o,i,p,l,m;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.params.id,s=r.user,a=r.userIsAdmin,r.body.title,u=[n],c=[n,s],1==a)return e.next=9,regeneratorRuntime.awrap(queryDbb.selectMessageForDiscussionDelete(u));e.next=40;break;case 9:o=e.sent,i=0;case 11:if(i<o.length)return p=[o[i].id],e.next=15,regeneratorRuntime.awrap(queryDbb.fileFind(p));e.next=34;break;case 15:return null!==(l=e.sent)[0].file&&(m=l[0].file.split("/images/")[1],fs.unlinkSync("./images/".concat(m))),e.prev=17,e.next=20,regeneratorRuntime.awrap(queryDbb.commentDeleteMessageId(p));case 20:return e.next=22,regeneratorRuntime.awrap(queryDbb.discussionDeleteLikeMessage(p));case 22:return e.next=24,regeneratorRuntime.awrap(queryDbb.discussionDeleteMessage(u));case 24:return e.next=26,regeneratorRuntime.awrap(queryDbb.discussionDelete(c));case 26:e.next=31;break;case 28:return e.prev=28,e.t0=e.catch(17),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 31:i++,e.next=11;break;case 34:return e.next=36,regeneratorRuntime.awrap(queryDbb.discussionDelete(c));case 36:return e.sent,e.abrupt("return",t.status(200).json("Discussion supprimée"));case 40:return e.abrupt("return",t.status(400).json({error:"Vous n'êtes pas autorisé à supprimer cette discussion"}));case 41:case"end":return e.stop()}},null,null,[[17,28]])},exports.createMessage=function(r,t){var n,s,a,u,c,o,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=r.body.text_message,a=r.body.discussionId,u=new Date,c=null,r.file&&(c="".concat(r.protocol,"://").concat(r.get("host"),"/images/").concat(r.file.filename)),o=[n,a,s,u,c],e.next=9,regeneratorRuntime.awrap(queryDbb.messageCreate(o));case 9:return i=e.sent,e.prev=10,e.abrupt("return",t.status(200).json(i));case 14:return e.prev=14,e.t0=e.catch(10),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 17:case"end":return e.stop()}},null,null,[[10,14]])},exports.getAllMessage=function(r,t){var n,s,a,u,c,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params.id,s=[n],e.next=4,regeneratorRuntime.awrap(queryDbb.messageSelectAll(s));case 4:a=e.sent,u=0;case 6:if(u<a.length)return c=[a[u].id],e.next=10,regeneratorRuntime.awrap(queryDbb.messageNbLike(c));e.next=21;break;case 10:o=e.sent,e.prev=11,a[u].nbLike=o[0].nb_like,e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(11),e.abrupt("return",t.status(500).json({error:error}));case 18:u++,e.next=6;break;case 21:return e.abrupt("return",t.status(200).json(a));case 22:case"end":return e.stop()}},null,null,[[11,15]])},exports.deleteMessage=function(r,t){var n,s,a,u,c,o,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=r.body.id,a=r.userIsAdmin,u=[s],e.next=6,regeneratorRuntime.awrap(queryDbb.messageUserIdBeforeDelete(u));case 6:if(c=e.sent,e.prev=7,c[0].user_id!=n&&0==a)return e.abrupt("return",t.status(400).json({message:"Vous ne pouvez pas supprimer ce message !"}));e.next=10;break;case 10:return e.next=12,regeneratorRuntime.awrap(queryDbb.commentDeleteMessageId(u));case 12:return e.next=14,regeneratorRuntime.awrap(queryDbb.messageDeleteLike(u));case 14:return e.next=16,regeneratorRuntime.awrap(queryDbb.fileFind(u));case 16:return null!==(o=e.sent)[0].file&&(i=o[0].file.split("/images/")[1],fs.unlinkSync("./images/".concat(i))),e.next=20,regeneratorRuntime.awrap(queryDbb.messageDelete(u));case 20:return e.abrupt("return",t.status(200).json({message:"Message supprimé"}));case 23:return e.prev=23,e.t0=e.catch(7),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 26:case"end":return e.stop()}},null,null,[[7,23]])},exports.likeMessage=function(r,t){var n,s,a,u,c,o,i,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=r.body.message_id,a=new Date,u=[n,s,a],c=[n,s],o=[n,s],e.next=8,regeneratorRuntime.awrap(queryDbb.messageUserLike(c));case 8:if(i=e.sent,e.prev=9,0<i.length)return e.next=13,regeneratorRuntime.awrap(queryDbb.messageUserDislike(o));e.next=16;break;case 13:return e.abrupt("return",t.status(200).json({message:"Like supprimé de la base"}));case 16:return e.next=18,regeneratorRuntime.awrap(queryDbb.messageLike(u));case 18:return p=e.sent,e.abrupt("return",t.status(200).json(p));case 20:e.next=25;break;case 22:return e.prev=22,e.t0=e.catch(9),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 25:case"end":return e.stop()}},null,null,[[9,22]])},exports.commentMessage=function(r,t){var n,s,a,u,c,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=r.body.message_id,a=r.body.text_comment,u=new Date,c=[n,s,a,u],e.next=7,regeneratorRuntime.awrap(queryDbb.messageCommentCreate(c));case 7:return o=e.sent,e.prev=8,e.abrupt("return",t.status(200).json(o));case 12:return e.prev=12,e.t0=e.catch(8),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 15:case"end":return e.stop()}},null,null,[[8,12]])},exports.getComment=function(r,t){var n,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return r.user,n=r.params.id,s=[n],e.next=5,regeneratorRuntime.awrap(queryDbb.commentSelectAll(s));case 5:return a=e.sent,e.prev=6,e.abrupt("return",t.status(200).json(a));case 10:return e.prev=10,e.t0=e.catch(6),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 13:case"end":return e.stop()}},null,null,[[6,10]])},exports.deleteComment=function(r,t){var n,s,a,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,s=r.body.id,a=r.userIsAdmin,u=[s],e.next=6,regeneratorRuntime.awrap(queryDbb.commentSelectUserIdBeforeDelete(u));case 6:if(e.sent[0].user_id!=n&&0==a)return e.abrupt("return",t.status(400).json({message:"Vous ne pouvez pas supprimer ce commentaire !"}));e.next=9;break;case 9:return e.prev=9,e.next=12,regeneratorRuntime.awrap(queryDbb.commentDeleteCommentId(u));case 12:return e.abrupt("return",t.status(200).json({message:"Commentaire supprimé"}));case 15:return e.prev=15,e.t0=e.catch(9),e.abrupt("return",t.status(500).json({error:"mysql2"}));case 18:case"end":return e.stop()}},null,null,[[9,15]])};
//# sourceMappingURL=discussion.min.js.map
